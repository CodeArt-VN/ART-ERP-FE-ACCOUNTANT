<ion-header>
  <app-toolbar [page]="this">
    <ion-button
      *ngIf="ShowAssignBranchAndBP && selectedItems.length>0 && pageConfig.canEdit"
      title="{{'Assign branch and contact' | translate}}"
      color="secondary"
      (click)="presentPopover()"
    >
      <ion-icon color="success" slot="icon-only" name="layers-outline"></ion-icon>
    </ion-button>
    <ion-button
      *ngIf="pageConfig.canEdit"
      (click)="FindMatchingCriteria()"
      title="{{'Find mactching criteria' | translate}}"
      color="secondary"
    >
      <ion-icon name="sync-circle-outline"></ion-icon>
    </ion-button>
  </app-toolbar>
</ion-header>
<ion-content appScrollbarTheme class="left" [ngClass]="{withFeature: pageConfig.isShowFeature}" forceOverscroll="false">
  <ion-refresher [disabled]="!pageConfig.refresher" slot="fixed" (ionRefresh)="refresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <ion-fab
    *ngIf="pageConfig.isShowFeature && groupControl.groupList.length>1"
    [ngClass]="{'ion-hide-md-down' : pageConfig.isSubActive}"
    class="feature no-print"
    vertical="bottom"
    horizontal="start"
    slot="fixed"
  >
    <ion-list>
      <ion-list-header lines="full">
        <ion-label color="dark">{{'Bank accounts' | translate}}</ion-label>
      </ion-list-header>
      <ion-item [color]="!groupControl.selectedGroup? 'primary': '' " lines="full" button (click)="onGroupChange(null)">
        <!-- <ion-icon aria-hidden="true" name="layers" slot="start"></ion-icon> -->
        <ion-label>{{'All' | translate}}</ion-label>
      </ion-item>

      <ng-container *ngFor="let g of groupControl.groupList">
        <ion-item-divider *ngIf="!g.IDParent">
          <ion-label>{{g.Name}}</ion-label>
        </ion-item-divider>

        <ng-container *ngIf="g.IDParent">
          <ion-item lines="full" button (click)="onGroupChange(g)" [color]="g.Id == groupControl.selectedGroup?.Id? 'primary': '' ">
            <ion-label>{{g.Code}}</ion-label>
          </ion-item>
          <ion-item lines="inset" [color]="g.Id == groupControl.selectedGroup?.Id? 'primary': '' ">
            <ion-icon slot="start" name="radio-button-on-outline" size="small"></ion-icon>
            <ion-label>{{'Working balance' | translate}}</ion-label>
            <ion-badge color="primary">{{g.WorkingBalance | number: '1.0-0' }}</ion-badge>
          </ion-item>
          <ion-item lines="inset" [color]="g.Id == groupControl.selectedGroup?.Id? 'primary': '' ">
            <ion-icon slot="start" name="radio-button-on-outline" size="small"></ion-icon>
            <ion-label>{{'Transactions total' | translate}}</ion-label>
            <ion-badge color="danger">{{g._TransactionTotal | number: '1.0-0' }}</ion-badge>
          </ion-item>
          <ion-item lines="inset" [color]="g.Id == groupControl.selectedGroup?.Id? 'primary': '' ">
            <ion-icon slot="start" name="radio-button-on-outline" size="small"></ion-icon>
            <ion-label>{{'Unrecognized count' | translate}}</ion-label>
            <ion-badge color="warning">{{g._UnrecognizedCount | number: '1.0-0' }}</ion-badge>
          </ion-item>
        </ng-container>

      

        



      </ng-container>
    </ion-list>
  </ion-fab>

  <div style="max-width: 1440px; margin: auto; width: 100%; position: sticky; left: 0" class="ion-padding">
    <app-page-title [pageConfig]="pageConfig"></app-page-title>
  </div>

  <div style="max-width: 1440px; margin: auto; width: 100%">
    <app-data-table
      style="width: 100%; min-width: calc(100% - 32px)"
      class="box-shadow responsive small-width"
      [rows]="items"
      [trackBy]="'Id'"
      [(selectedRows)]="selectedItems"
      [showSpinner]="pageConfig.showSpinner"
      [showFilter]="pageConfig.isShowSearch"
      [(query)]="query"
      (dataInfinite)="loadData($event)"
      (filter)="onDatatableFilter($event)"
      (sort)="onSort($event)"
      (activate)="changeSelection($event)"
    >
      <datatable-column [checkbox]="true" name=""></datatable-column>
      <datatable-column class="col-id" name="Reference number" property="ReferenceNumber">
        <ng-template let-i="row" datatable-cell-template>
          <a [routerLink]="['/'+pageConfig.pageName+'/'+i.Id]">{{i.ReferenceNumber}}</a>
        </ng-template>
      </datatable-column>
      <datatable-column
        class="col-date"
        format="yyyy-MM-dd HH:mm"
        name="Transaction date"
        property="TransactionDate"
      ></datatable-column>
      <datatable-column class="col-name flex-break" name="Remark" property="Remark">
        <ng-template let-i="row" datatable-cell-template>
          <div>
            <a *ngIf="i._BusinessPartner" class="bold" [routerLink]="['/business-partner/'+i._BusinessPartner.Id]">
              <ion-text [color]="i._ReconciliationStatus?.Color">{{i._BusinessPartner.Name}}</ion-text>
              <small>{{i._BusinessPartner.Id}}</small>
            </a>
            <div *ngIf="i.Remark">{{i.Remark}}</div>
          </div>
        </ng-template>
      </datatable-column>
      <datatable-column class="col-number" name="Amount" property="Amount">
        <ng-template let-i="row" datatable-cell-template>
          <ion-text class="bold" color="{{i.Amount > 0 ? 'success' : 'danger'}}">{{i.Amount | number: '1.0'}}</ion-text>
        </ng-template>
      </datatable-column>
      <datatable-column class="col-status" name="Reconciliation status" property="ReconciliationStatus">
        <ng-template let-i="row" datatable-cell-template>
          <ion-badge
            *ngIf="i._ReconciliationStatus"
            [color]="i._ReconciliationStatus?.Color"
            [title]="i._ReconciliationStatus?.Name"
          >
            {{i._ReconciliationStatus?.Name}}
          </ion-badge>
        </ng-template>
      </datatable-column>
    </app-data-table>
  </div>
  <ion-popover class="w300" #popover [isOpen]="isOpenPopover" (didDismiss)="dismissPopover()">
    <ng-template>
      <ion-content appScrollbarTheme>
        <ion-grid>
          <form [formGroup]="formGroup" (submit)="dismissPopover(true)">
            <ion-row>
              <ion-col size="12" size-sm size-xl="12">
                <div class="c-control">
                  <label class="c-label" for="IDBranch"
                    >{{'Branch' | translate}}
                    <span
                      *ngIf="!formGroup.controls.IDBranch.valid && !formGroup.controls.IDBranch.pending && (formGroup.controls.IDBranch.dirty || submitAttempt)"
                      ion-text
                      color="danger"
                      >(*)</span
                    >
                  </label>
                  <ng-select
                    class="c-input"
                    (change)="changeIDBranch()"
                    labelForId="IDBranch"
                    formControlName="IDBranch"
                    [items]="branchList"
                    [virtualScroll]="true"
                    bindLabel="Name"
                    bindValue="Id"
                    placeholder="{{'Search...' | translate}}"
                  >
                    <ng-template ng-option-tmp let-i="item" let-search="searchTerm">
                      <div *ngIf="i">
                        <div>
                          <span *ngFor="let l of i.levels">&nbsp;&nbsp;&nbsp;</span>
                          <span [ngOptionHighlight]="search">{{i.Name}}</span>
                        </div>
                      </div>
                    </ng-template>
                  </ng-select>
                </div>
                <app-form-control
                  [form]="formGroup"
                  type="ng-select-bp"
                  label="Contact"
                  id="IDContact"
                  [dataSource]="_contactDataSource"
                  (change)="changeBP($event)"
                  bindValue="Id"
                  bindLabel="Name"
                  [clearable]="true"
                ></app-form-control>
              </ion-col>
            </ion-row>
          </form>
        </ion-grid>
      </ion-content>
      <ion-button class="ion-margin" size="small" expand="block" (click)="dismissPopover(true)">Apply</ion-button>
    </ng-template>
  </ion-popover>
  <div class="ion-padding"></div>
  <ion-infinite-scroll
    color="primary"
    threshold="30%"
    (ionInfinite)="loadData($event)"
    [disabled]="!pageConfig.infiniteScroll || pageConfig.isEndOfData"
  >
    <ion-infinite-scroll-content loadingSpinner="dots"></ion-infinite-scroll-content>
  </ion-infinite-scroll>
</ion-content>
